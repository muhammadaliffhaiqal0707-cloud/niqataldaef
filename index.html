<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIQAT Al-Daef - Security Scanner</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load html2pdf.js for generating reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Configure Tailwind to use custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e0538',
                        'accent-pink': '#e91e63',
                        'accent-cyan': '#00bcd4',
                        'accent-purple': '#8e24aa',
                        'bg-card': '#250841',
                        'scan-yellow': '#ffeb3b', // Added for scan logs
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        /* Custom background gradient for the body */
        body {
            background: linear-gradient(135deg, #1e0538 0%, #0d0216 100%);
            min-height: 100vh;
            color: #f0f0f0;
            font-family: 'Inter', sans-serif;
        }

        /* Scrollbar styles for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #250841;
        }

        ::-webkit-scrollbar-thumb {
            background: #8e24aa;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a140c7;
        }

        /* Specific classes for text styles */
        .log-clean { color: #00bcd4; }
        .log-suspicious { color: #ffeb3b; }
        .log-malicious { color: #e91e63; }
        .log-harmless { color: #4caf50; }

        /* Custom glow for active state */
        .input-glow:focus {
            box-shadow: 0 0 0 2px rgba(142, 36, 170, 0.5); /* accent-purple */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Firebase SDK (module script required for imports) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- MANDATORY CANVAS GLOBALS ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // ---------------------------------

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expose Firebase services globally for use in the non-module script
        window.firebase = {
            db, auth, initialAuthToken, appId,
            onAuthStateChanged, signInWithCustomToken, signInAnonymously, signOut,
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs,
            orderBy, limit, serverTimestamp
        };
        
        // Notify the main script that Firebase is ready and exposed
        document.dispatchEvent(new CustomEvent('firebase-ready'));

    </script>

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto bg-bg-card rounded-xl shadow-2xl p-6 sm:p-10">
        <!-- Initial content is empty; JS will inject the loading state immediately -->
    </div>

    <!-- Message Box Modal -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-bg-card p-6 rounded-lg shadow-xl max-w-sm w-full border-t-4 border-accent-pink">
            <h3 id="message-box-title" class="text-xl font-bold mb-3 text-accent-cyan">Title</h3>
            <p id="message-box-content" class="text-gray-300"></p>
            <button onclick="document.getElementById('message-box').classList.add('hidden')"
                    class="mt-4 w-full bg-accent-pink hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                Close
            </button>
        </div>
    </div>

    <!-- Main JavaScript Logic -->
    <script>
        // --- GLOBAL STATE MANAGEMENT ---
        let state = {
            isAuthenticated: false,
            user: null,
            userId: null,
            currentPage: 'home', // 'home', 'scan', 'scanning', 'results', 'history', 'auth'
            urlInput: '',
            selectedModules: {
                virustotal: true,
                dns: false,
                whois: false,
                portscan: false,
            },
            isScanning: false,
            scanLog: [],
            scanResults: null,
            history: [],
            loginEmail: '',
            loginPassword: '',
            isAuthReady: false, // Tracks when auth check is complete
        };
        
        // --- VIRUSTOTAL API INTEGRATION ---
        const API_KEY = 'cc3c00b8268e5c123e3aa8d11465a10e805bbfacfe7a1a001df8f483504e26c2';

        async function performVirusTotalScan(urlToScan) {
            const headers = { 'x-apikey': API_KEY, 'Content-Type': 'application/x-www-form-urlencoded' };
            const scanData = { url: urlToScan, summary: null, vendor_analysis: [] };

            try {
                // Step 1: Submit the URL for scanning (This usually primes the cache)
                logScanActivity(`[VT] Submitting URL for analysis...`);
                const submitResponse = await fetch('https://www.virustotal.com/api/v3/urls', {
                    method: 'POST',
                    headers: headers,
                    body: `url=${encodeURIComponent(urlToScan)}`
                });

                if (submitResponse.status === 409) {
                     logScanActivity(`[VT] Analysis already exists or is in progress (Code 409). Proceeding to report retrieval.`, 'log-suspicious');
                } else if (!submitResponse.ok) {
                    throw new Error(`Submission failed: ${submitResponse.status} - ${submitResponse.statusText}`);
                }

                // Step 2: Encode URL to get its ID (Base64 URL-safe, strip trailing '=')
                const urlId = btoa(urlToScan).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
                const reportUrl = `https://www.virustotal.com/api/v3/urls/${urlId}`;
                
                // Step 3: Wait and Retrieve the report
                logScanActivity(`[VT] Waiting 5 seconds for initial report generation...`, 'log-suspicious');
                await new Promise(resolve => setTimeout(resolve, 5000)); 

                logScanActivity(`[VT] Retrieving final report...`);
                const reportResponse = await fetch(reportUrl, { method: 'GET', headers: headers });
                
                if (reportResponse.status === 404) {
                     throw new Error("Report not yet available. The URL may be too new for quick lookup.");
                }
                if (!reportResponse.ok) {
                    throw new Error(`Report retrieval failed: ${reportResponse.status} - ${reportResponse.statusText}`);
                }
                
                const reportData = await reportResponse.json();

                // Step 4: Extract and format summary stats
                const attributes = reportData.data.attributes;
                const stats = attributes.last_analysis_stats || {};
                const analysisResults = attributes.last_analysis_results || {};
                
                const maliciousCount = stats.malicious || 0;
                const totalVendors = Object.keys(analysisResults).length;

                scanData.summary = {
                    'Harmless': stats.harmless || 0,
                    'Suspicious': stats.suspicious || 0,
                    'Malicious': maliciousCount,
                    'Undetected': stats.undetected || 0,
                    'Total_Vendors': totalVendors
                };
                
                // Format vendor-specific results
                for (const vendor in analysisResults) {
                    const result = analysisResults[vendor];
                    scanData.vendor_analysis.push({
                        vendor: vendor,
                        category: result.category || 'N/A',
                        result: result.result || 'Clean'
                    });
                }
                
                if (maliciousCount > 0) {
                    logScanActivity(`[VT] SCAN COMPLETE: ${maliciousCount}/${totalVendors} vendors flagged this URL as MALICIOUS!`, 'log-malicious');
                } else if (stats.suspicious > 0) {
                     logScanActivity(`[VT] SCAN COMPLETE: ${stats.suspicious}/${totalVendors} vendors flagged this URL as SUSPICIOUS.`, 'log-suspicious');
                } else {
                     logScanActivity(`[VT] SCAN COMPLETE: 0 malicious flags. URL appears CLEAN.`, 'log-clean');
                }
                
                return { success: true, data: scanData };

            } catch (e) {
                const errorMsg = e.message || "An unknown error occurred during VirusTotal scan.";
                logScanActivity(`[VT] ERROR: ${errorMsg}`, 'log-malicious');
                return { success: false, error: errorMsg };
            }
        }

        // --- AUTH & FIREBASE ---
        let db, auth;

        async function initializeFirebaseAndAuth() {
            if (!window.firebase) {
                console.error("Firebase object not found. Cannot initialize.");
                updateState({ isAuthReady: true });
                return;
            }

            db = window.firebase.db;
            auth = window.firebase.auth;

            // 1. Set up Auth State Listener FIRST
            window.firebase.onAuthStateChanged(auth, async (user) => {
                const newState = {
                    isAuthenticated: !!user && !user.isAnonymous,
                    user: user,
                    userId: user ? user.uid : null,
                    isAuthReady: true, // Mark auth check as complete
                };
                
                // Only update the state and render once auth status is known
                updateState(newState);

                if (user) {
                    // Start listening for scan history only after auth is ready
                    fetchScanHistory();
                    if (state.currentPage === 'home') {
                        navigateTo('scan'); // Default to scan page if authenticated
                    }
                } else {
                    updateState({ history: [] });
                }
            });

            // 2. Initial Sign-in Attempt
            try {
                if (window.firebase.initialAuthToken) {
                    await window.firebase.signInWithCustomToken(auth, window.firebase.initialAuthToken);
                } else {
                    await window.firebase.signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Initial sign-in failed, attempting anonymous fallback:", e);
                try {
                    await window.firebase.signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Anonymous sign-in failed:", anonError);
                }
            }
        }

        function getHistoryCollectionRef(uid) {
             const { collection } = window.firebase;
             // Private data path for scan history: /artifacts/{appId}/users/{userId}/scan_history
             return collection(db, 'artifacts', window.firebase.appId, 'users', uid, 'scan_history');
        }

        function fetchScanHistory() {
            if (!state.userId || !db) return;
            const { query, orderBy, limit, onSnapshot } = window.firebase;
            
            const historyQuery = query(
                getHistoryCollectionRef(state.userId),
                orderBy('timestamp', 'desc'),
                limit(10)
            );

            // Use onSnapshot for real-time updates
            onSnapshot(historyQuery, (snapshot) => {
                const history = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Convert Firestore Timestamp to Date for display
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate().toLocaleString() : 'N/A'
                }));
                updateState({ history: history });
            }, (error) => {
                console.error("Error fetching scan history:", error);
                logScanActivity("Error fetching history: " + error.message, 'log-malicious');
            });
        }

        async function saveScanResult(scanResult) {
            if (!state.userId || !db || !scanResult || auth.currentUser.isAnonymous) return; // Do not save history for anonymous users
            try {
                const { addDoc, serverTimestamp } = window.firebase;
                await addDoc(getHistoryCollectionRef(state.userId), {
                    url: scanResult.url,
                    summary: scanResult.summary,
                    vendor_analysis: scanResult.vendor_analysis,
                    timestamp: serverTimestamp(),
                    isMalicious: scanResult.summary.Malicious > 0,
                });
            } catch (e) {
                console.error("Error saving scan result:", e);
                showMessageBox("Database Error", "Failed to save scan result to history. Please check console for details.");
            }
        }
        
        // --- AUTH HANDLERS ---
        async function handleLogin() {
            const { signInWithEmailAndPassword } = window.firebase;
            if (!state.loginEmail || !state.loginPassword) {
                showMessageBox("Login Failed", "Please enter both email and password.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, state.loginEmail, state.loginPassword);
                navigateTo('scan');
                updateState({ loginEmail: '', loginPassword: '' });
            } catch (e) {
                showMessageBox("Login Failed", `Error: ${e.message}`);
            }
        }

        async function handleRegister() {
            const { createUserWithEmailAndPassword } = window.firebase;
            if (!state.loginEmail || !state.loginPassword) {
                showMessageBox("Registration Failed", "Please enter both email and password.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, state.loginEmail, state.loginPassword);
                navigateTo('scan');
                updateState({ loginEmail: '', loginPassword: '' });
            } catch (e) {
                showMessageBox("Registration Failed", `Error: ${e.message}`);
            }
        }

        async function handleGuestLogin() {
            const { signInAnonymously } = window.firebase;
            try {
                await signInAnonymously(auth);
                navigateTo('scan');
            } catch (e) {
                showMessageBox("Guest Login Failed", `Error: ${e.message}`);
            }
        }

        async function handleLogout() {
            const { signOut } = window.firebase;
            try {
                await signOut(auth);
                updateState({ history: [] });
                navigateTo('home');
            } catch (e) {
                showMessageBox("Logout Failed", `Error: ${e.message}`);
            }
        }
        
        // --- UTILITY FUNCTIONS ---
        function updateState(newState) {
            state = { ...state, ...newState };
            renderApp();
        }

        function showMessageBox(title, content) {
            document.getElementById('message-box-title').textContent = title;
            document.getElementById('message-box-content').textContent = content;
            document.getElementById('message-box').classList.remove('hidden');
        }

        function navigateTo(page) {
            // If the user is trying to navigate to history but is not authenticated, redirect to auth
             if (page === 'history' && (!state.userId || auth.currentUser.isAnonymous)) {
                showMessageBox("Authentication Required", "Please log in with an email/password account to view your scan history.");
                page = 'auth';
             }
            updateState({ currentPage: page });
        }

        // --- SCANNING LOGIC ---
        function validateUrl(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }

        function toggleModule(module) {
            updateState({
                selectedModules: {
                    ...state.selectedModules,
                    [module]: !state.selectedModules[module]
                }
            });
        }

        function logScanActivity(message, className = 'text-gray-400') {
            const timestamp = new Date().toLocaleTimeString();
            // We prepend the new log entry for reverse chronological order in the display
            updateState({ scanLog: [{ timestamp, message, className }, ...state.scanLog] });
        }

        async function startScan() {
            const urlToScan = state.urlInput.trim();
            
            // Wait for Firebase to confirm auth state before allowing scan
            if (!state.isAuthReady) {
                showMessageBox("Initialization Incomplete", "Please wait until the secure environment finishes initialization before scanning.");
                return;
            }

            if (!validateUrl(urlToScan)) {
                showMessageBox("Invalid URL", "Please enter a valid URL, including the protocol (e.g., https://).");
                return;
            }

            const activeModules = Object.values(state.selectedModules).some(v => v === true);
            
            if (activeModules) {
                // Clear previous state and start scanning mode
                updateState({
                    isScanning: true,
                    scanLog: [{ timestamp: new Date().toLocaleTimeString(), message: `Starting scan on: ${urlToScan}`, className: 'text-accent-cyan' }],
                    scanResults: null,
                    currentPage: 'scanning',
                });

                // --- VIRUSTOTAL INTEGRATION ---
                const vtResult = await performVirusTotalScan(urlToScan);
                
                if (vtResult.success) {
                    // Update state with final results and save to history
                    const fullResult = { ...vtResult.data, url: urlToScan };
                    
                    // Save result (only for non-anonymous, will check internally)
                    await saveScanResult(fullResult);
                    
                    updateState({
                        scanResults: fullResult,
                        isScanning: false,
                        currentPage: 'results',
                    });
                } else {
                    // Handle API error
                    updateState({
                        isScanning: false,
                        currentPage: 'scan',
                        scanLog: [{ timestamp: new Date().toLocaleTimeString(), message: `FATAL ERROR: ${vtResult.error}`, className: 'log-malicious' }, ...state.scanLog],
                    });
                }
                
            } else {
                showMessageBox("Module Selection", "Please select at least one scan module before starting the scan.");
            }
        }


        function downloadReportPdf() {
            if (!state.scanResults) {
                showMessageBox("Download Failed", "No scan results available to generate a report.");
                return;
            }

            const element = document.getElementById('report-content');
            
            // Clone and prepare element for PDF generation (remove irrelevant buttons/UI)
            const content = element.cloneNode(true);
            const titleEl = document.createElement('h1');
            titleEl.textContent = `Security Scan Report: ${state.scanResults.url}`;
            titleEl.className = 'text-2xl font-bold mb-4 text-gray-800';
            
            const dateEl = document.createElement('p');
            dateEl.textContent = `Generated on: ${new Date().toLocaleString()}`;
            dateEl.className = 'mb-6 text-gray-600';

            const container = document.createElement('div');
            container.style.padding = '20px';
            container.style.backgroundColor = '#ffffff'; // White background for PDF
            container.appendChild(titleEl);
            container.appendChild(dateEl);
            container.appendChild(content);

            // Options for html2pdf
            const options = {
                margin: 10,
                filename: `scan_report_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Generate the PDF
            html2pdf().from(container).set(options).save();
        }


        // --- RENDERING FUNCTIONS ---
        function renderHeader() {
            const userStatus = state.isAuthenticated ? 
                `<span class="text-accent-cyan font-semibold">User: ${state.user.email || state.userId}</span>` : 
                (state.user && state.user.isAnonymous ? `<span class="text-scan-yellow font-semibold">Guest: ${state.userId}</span>` : `<span class="text-accent-pink font-semibold">Not Authenticated</span>`);
                
            // Truncate userId for display only, keep full ID in state
            const displayUserId = state.userId ? `${state.userId.substring(0, 8)}...` : 'Connecting...';


            return `
                <header class="flex justify-between items-center pb-4 border-b border-gray-700/50 mb-6">
                    <div class="flex items-center space-x-2">
                        <svg class="w-8 h-8 text-accent-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944c-1.396 0-2.735.341-3.92.981a11.955 11.955 0 00-4.662 4.662c-.64 1.185-.981 2.524-.981 3.92s.341 2.735.981 3.92a11.955 11.955 0 004.662 4.662c1.185.64 2.524.981 3.92.981a11.955 11.955 0 004.662-4.662c.64-1.185.981-2.524.981-3.92s-.341-2.735-.981-3.92a11.955 11.955 0 00-4.662-4.662z"></path></svg>
                        <h1 class="text-2xl font-bold text-white">NIQAT Al-Daef</h1>
                    </div>
                    <div class="text-sm text-right">
                        ${state.isAuthReady ? userStatus : `<span class="text-gray-500">User ID: ${displayUserId}</span>`}
                        ${state.user ? 
                            `<button onclick="handleLogout()" class="ml-3 text-red-400 hover:text-red-500 transition">Logout</button>` : 
                            (state.isAuthReady ? `<button onclick="navigateTo('auth')" class="ml-3 text-accent-cyan hover:text-cyan-500 transition">Login/Register</button>` : '')}
                    </div>
                </header>
            `;
        }

        function renderNavBar() {
            const linkClass = (page) => `px-4 py-2 rounded-lg font-medium transition duration-200 ${state.currentPage === page ? 'bg-accent-purple text-white shadow-lg' : 'text-gray-300 hover:bg-bg-card'}`;
            
            const historyDisabled = !state.userId || (state.user && state.user.isAnonymous);
            
            return `
                <nav class="flex justify-center space-x-3 mb-8 bg-bg-card p-2 rounded-xl shadow-inner">
                    <button onclick="navigateTo('scan')" class="${linkClass('scan')}">New Scan</button>
                    <button onclick="navigateTo('history')" class="${linkClass('history')}" ${historyDisabled ? 'disabled title="Login to view history"' : ''}>Scan History</button>
                    ${!state.isAuthenticated && state.isAuthReady ? `<button onclick="navigateTo('auth')" class="${linkClass('auth')}">Auth</button>` : ''}
                </nav>
            `;
        }
        
        function renderHome() {
            return `
                <div class="text-center p-10">
                    <h2 class="text-4xl font-extrabold text-accent-cyan mb-4">Welcome to NIQAT Al-Daef</h2>
                    <p class="text-gray-300 mb-8 max-w-lg mx-auto">
                        Your advanced, comprehensive web security scanner. Use our integrated modules to check URLs against VirusTotal, perform DNS lookups, WHOIS queries, and more.
                    </p>
                    <div class="space-x-4">
                        <button onclick="navigateTo('scan')" class="bg-accent-pink hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transition transform hover:scale-105">
                            Start Scanning Now
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAuth() {
             return `
                <div class="max-w-md mx-auto p-6 bg-bg-card rounded-xl shadow-lg border border-primary-dark">
                    <h2 class="text-3xl font-bold text-accent-cyan mb-6 text-center">Authentication</h2>
                    
                    <input 
                        type="email" 
                        placeholder="Email" 
                        value="${state.loginEmail}"
                        oninput="updateState({ loginEmail: event.target.value })"
                        class="w-full p-3 mb-4 bg-primary-dark text-white border border-gray-600 rounded-lg input-glow"
                    >
                    <input 
                        type="password" 
                        placeholder="Password"
                        value="${state.loginPassword}"
                        oninput="updateState({ loginPassword: event.target.value })"
                        class="w-full p-3 mb-6 bg-primary-dark text-white border border-gray-600 rounded-lg input-glow"
                    >

                    <div class="flex space-x-4 mb-6">
                        <button onclick="handleLogin()" class="flex-1 bg-accent-purple hover:bg-purple-800 text-white font-bold py-3 rounded-lg transition">
                            Login
                        </button>
                        <button onclick="handleRegister()" class="flex-1 bg-accent-cyan hover:bg-cyan-600 text-white font-bold py-3 rounded-lg transition">
                            Register
                        </button>
                    </div>

                    <div class="text-center my-4 text-gray-400">OR</div>

                    <button onclick="handleGuestLogin()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition">
                        Continue as Guest
                    </button>
                    <p class="text-xs text-gray-500 mt-3 text-center">Guest mode does not save scan history.</p>
                </div>
            `;
        }

        function renderScanInput() {
            const moduleData = [
                { id: 'virustotal', name: 'VirusTotal (Real)', description: 'Comprehensive file/URL analysis from multiple engines.' },
                { id: 'dns', name: 'DNS Lookup (Mock)', description: 'Resolve domain to IP address and check common records.' },
                { id: 'whois', name: 'WHOIS Query (Mock)', description: 'Retrieve registration and ownership details for a domain.' },
                { id: 'portscan', name: 'Port Scan (Mock)', description: 'Check for common open ports on the target host.' },
            ];
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <h2 class="text-3xl font-bold text-accent-cyan mb-4">Target URL</h2>
                        <input 
                            type="url" 
                            placeholder="Enter URL (e.g., https://malicious.link)"
                            value="${state.urlInput}"
                            oninput="updateState({ urlInput: event.target.value })"
                            class="w-full p-4 mb-4 text-lg bg-primary-dark text-white border border-gray-600 rounded-lg input-glow"
                        >
                        <button 
                            onclick="startScan()" 
                            class="w-full bg-accent-pink hover:bg-red-700 text-white font-bold py-4 rounded-lg shadow-2xl transition duration-300 transform hover:scale-[1.01]"
                        >
                            <span class="text-xl">ðŸš€ Start Scan</span>
                        </button>

                        <div class="mt-8">
                            <h2 class="text-xl font-bold text-white mb-3">Scan Logs</h2>
                            <div id="scan-log" class="h-64 overflow-y-auto bg-primary-dark p-4 rounded-lg border border-gray-700/50 space-y-1 text-sm">
                                ${state.scanLog.map(log => 
                                    `<p class="text-gray-500"><span class="font-mono text-gray-600">[${log.timestamp}]</span> <span class="${log.className}">${log.message}</span></p>`
                                ).join('')}
                                ${state.scanLog.length === 0 ? '<p class="text-gray-500">Scan activities will appear here...</p>' : ''}
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1">
                        <h2 class="text-3xl font-bold text-accent-cyan mb-4">Scan Modules</h2>
                        <div class="space-y-4">
                            ${moduleData.map(module => `
                                <div onclick="toggleModule('${module.id}')" 
                                    class="p-4 bg-bg-card rounded-lg shadow-md cursor-pointer border transition duration-200 
                                    ${state.selectedModules[module.id] ? 'border-accent-cyan ring-4 ring-accent-cyan/30' : 'border-gray-700 hover:border-accent-purple'}">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-white">${module.name}</span>
                                        <input type="checkbox" ${state.selectedModules[module.id] ? 'checked' : ''} class="form-checkbox text-accent-cyan bg-primary-dark border-gray-600 rounded cursor-pointer pointer-events-none">
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">${module.description}</p>
                                </div>
                            `).join('')}
                        </div>
                        <p class="text-sm text-gray-500 mt-4">Note: Only VirusTotal is fully functional; others are mock modules.</p>
                    </div>
                </div>
            `;
        }
        
        function renderScanning() {
            // Display scanning in progress with a loading indicator and logs
            return `
                <div class="text-center p-10">
                    <h2 class="text-4xl font-extrabold text-accent-cyan mb-4">Scanning in Progress...</h2>
                    <p class="text-gray-300 mb-8 max-w-lg mx-auto">Analyzing ${state.urlInput} with selected modules.</p>
                    
                    <div class="w-full max-w-sm mx-auto h-2 bg-primary-dark rounded-full overflow-hidden mb-8">
                        <div class="h-full bg-accent-pink animate-pulse" style="width: 100%;"></div>
                    </div>

                    <div class="mt-8 text-left">
                        <h2 class="text-xl font-bold text-white mb-3">Real-time Scan Logs</h2>
                        <div id="scan-log" class="h-96 overflow-y-auto bg-primary-dark p-4 rounded-lg border border-gray-700/50 space-y-1 text-sm">
                            ${state.scanLog.map(log => 
                                `<p class="text-gray-500"><span class="font-mono text-gray-600">[${log.timestamp}]</span> <span class="${log.className}">${log.message}</span></p>`
                            ).join('')}
                        </div>
                    </div>
                    
                    ${!state.isScanning ? `
                        <button onclick="navigateTo('scan')" class="mt-8 bg-accent-purple hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg transition">
                            Back to Scan Input
                        </button>
                    ` : ''}
                </div>
            `;
        }
        
        function renderResults() {
            const results = state.scanResults;
            if (!results) return renderScanInput(); // Fallback if no results

            const summary = results.summary || {};
            const vendors = results.vendor_analysis || [];
            
            const maliciousCount = summary.Malicious || 0;
            const totalVendors = summary.Total_Vendors || 0;
            
            let statusClass, statusText;
            if (maliciousCount > 0) {
                statusClass = 'bg-red-900 border-red-500 text-red-300';
                statusText = 'MALICIOUS';
            } else if (summary.Suspicious > 0) {
                statusClass = 'bg-yellow-900 border-yellow-500 text-yellow-300';
                statusText = 'SUSPICIOUS';
            } else {
                statusClass = 'bg-green-900 border-green-500 text-green-300';
                statusText = 'CLEAN';
            }

            return `
                <div class="p-4 sm:p-6 bg-primary-dark rounded-xl" id="report-content">
                    <h2 class="text-3xl font-bold text-accent-cyan mb-2">Scan Results</h2>
                    <p class="text-gray-400 mb-6 break-words">URL: ${results.url}</p>

                    <div class="flex justify-between items-center p-4 rounded-lg border ${statusClass} mb-6">
                        <span class="text-xl font-bold">Overall Status:</span>
                        <span class="text-2xl font-extrabold">${statusText}</span>
                    </div>

                    <h3 class="text-2xl font-bold text-white mb-3 mt-6">ðŸ“Š VirusTotal Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-bg-card p-4 rounded-lg text-center border-t-4 border-green-500">
                            <p class="text-xs text-gray-400">Harmless</p>
                            <p class="text-2xl font-bold text-green-400">${summary.Harmless}</p>
                        </div>
                        <div class="bg-bg-card p-4 rounded-lg text-center border-t-4 border-yellow-500">
                            <p class="text-xs text-gray-400">Suspicious</p>
                            <p class="text-2xl font-bold text-yellow-400">${summary.Suspicious}</p>
                        </div>
                        <div class="bg-bg-card p-4 rounded-lg text-center border-t-4 border-red-500">
                            <p class="text-xs text-gray-400">Malicious</p>
                            <p class="text-2xl font-bold text-red-400">${maliciousCount}</p>
                        </div>
                        <div class="bg-bg-card p-4 rounded-lg text-center border-t-4 border-gray-500">
                            <p class="text-xs text-gray-400">Total Vendors</p>
                            <p class="text-2xl font-bold text-white">${totalVendors}</p>
                        </div>
                    </div>
                    
                    <p class="text-lg text-gray-300 mb-6">
                        <span class="font-bold text-accent-pink">${maliciousCount} / ${totalVendors}</span> security vendors flagged this URL as malicious.
                    </p>

                    <h3 class="text-2xl font-bold text-white mb-3 mt-6">ðŸ§ª Vendor Analysis Detail</h3>
                    <div class="max-h-96 overflow-y-auto bg-primary-dark p-4 rounded-lg border border-gray-700/50">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="text-gray-400 uppercase tracking-wider border-b border-gray-700">
                                    <th class="py-2 px-1">Vendor</th>
                                    <th class="py-2 px-1">Category</th>
                                    <th class="py-2 px-1">Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${vendors.map(v => {
                                    const vendorClass = v.category === 'malicious' ? 'text-red-400 font-bold' : 
                                                        v.category === 'suspicious' ? 'text-yellow-400' : 
                                                        'text-green-400';
                                    return `
                                        <tr class="border-b border-gray-800 last:border-b-0">
                                            <td class="py-2 px-1">${v.vendor}</td>
                                            <td class="py-2 px-1 ${vendorClass}">${v.category}</td>
                                            <td class="py-2 px-1 text-gray-300">${v.result}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-4">
                    <button onclick="downloadReportPdf()" class="bg-accent-purple hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg transition">
                        Download PDF Report
                    </button>
                    <button onclick="navigateTo('scan')" class="bg-accent-cyan hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition">
                        New Scan
                    </button>
                </div>
            `;
        }
        
        function renderHistory() {
             if (!state.userId || (state.user && state.user.isAnonymous)) {
                 return `
                    <div class="text-center p-10 bg-bg-card rounded-xl">
                        <h2 class="text-3xl font-bold text-accent-pink mb-4">Access Denied</h2>
                        <p class="text-gray-300 mb-8 max-w-lg mx-auto">
                            Scan history is only available to logged-in users. Please log in or register to save and view your past scans.
                        </p>
                        <button onclick="navigateTo('auth')" class="bg-accent-cyan hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg transition">
                            Login / Register
                        </button>
                    </div>
                 `;
             }

            return `
                <div class="p-4 sm:p-6 bg-primary-dark rounded-xl">
                    <h2 class="text-3xl font-bold text-accent-cyan mb-6">Scan History (${state.history.length})</h2>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        ${state.history.length === 0 ? 
                            `<p class="text-gray-500 p-4 text-center">No scan history found. Start a new scan!</p>` 
                            : state.history.map(item => {
                                const statusClass = item.isMalicious ? 'bg-red-800/50 border-red-500' : 'bg-green-800/50 border-green-500';
                                return `
                                    <div class="p-4 rounded-lg shadow-md border-l-4 ${statusClass} cursor-pointer hover:bg-bg-card transition"
                                         onclick="updateState({ scanResults: { url: '${item.url}', summary: ${JSON.stringify(item.summary)}, vendor_analysis: ${JSON.stringify(item.vendor_analysis)} }, currentPage: 'results' })">
                                        <div class="flex justify-between items-center mb-1">
                                            <p class="font-semibold text-white break-all">${item.url}</p>
                                            <span class="text-xs text-gray-300">${item.timestamp}</span>
                                        </div>
                                        <p class="text-sm text-gray-400">
                                            Status: 
                                            <span class="${item.isMalicious ? 'text-red-400 font-bold' : 'text-green-400'}">
                                                ${item.isMalicious ? 'Malicious' : 'Clean'}
                                            </span>
                                            (${item.summary.Malicious || 0} / ${item.summary.Total_Vendors || 0} flags)
                                        </p>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                    <p class="text-xs text-gray-500 mt-4 text-center">Click an item to view the full report.</p>
                </div>
            `;
        }


        function renderApp() {
            const appElement = document.getElementById('app');
            if (!appElement) return;

            let contentHTML = '';

            if (!state.isAuthReady) {
                 // Display the loading spinner until isAuthReady is true
                 appElement.innerHTML = `
                    <div class="text-center py-20">
                        <div class="w-12 h-12 border-4 border-t-4 border-t-accent-cyan border-gray-700 rounded-full animate-spin mx-auto"></div>
                        <p class="mt-4 text-white">Initializing Secure Environment...</p>
                        <p class="text-xs text-gray-500">User ID: ${state.userId || 'Connecting...'}</p>
                    </div>
                `;
                return;
            }
            
            // Render the main application frame once initialization is complete
            let mainContent = '';
            switch (state.currentPage) {
                case 'scan':
                    mainContent = renderScanInput();
                    break;
                case 'scanning':
                    mainContent = renderScanning();
                    break;
                case 'results':
                    mainContent = renderResults();
                    break;
                case 'history':
                    mainContent = renderHistory();
                    break;
                case 'auth':
                    mainContent = renderAuth();
                    break;
                case 'home':
                default:
                    mainContent = renderHome();
            }

            contentHTML = `
                ${renderHeader()}
                ${state.currentPage !== 'auth' ? renderNavBar() : ''}
                <main class="min-h-[500px]">
                    ${mainContent}
                </main>
            `;
            
            appElement.innerHTML = contentHTML;
        }


        // Expose functions to global window object for inline event handlers
        window.validateUrl = validateUrl;
        window.toggleModule = toggleModule;
        window.startScan = startScan;
        window.downloadReportPdf = downloadReportPdf;
        window.navigateTo = navigateTo;
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleGuestLogin = handleGuestLogin;
        window.handleLogout = handleLogout;


        // Initial setup listener: Wait for Firebase imports to finish and expose global variables
        document.addEventListener('firebase-ready', () => {
             // Now Firebase services are available in window.firebase
             initializeFirebaseAndAuth();
        });
        
        // CRITICAL FIX: Render the initial state immediately to show the loading screen and dynamic text
        renderApp();
        
    </script>
</body>
</html>
