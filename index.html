<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIQAT Al-Daef - Security Scanner</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load html2pdf.js for generating reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Configure Tailwind to use custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e0538',
                        'accent-pink': '#e91e63',
                        'accent-cyan': '#00bcd4',
                        'accent-purple': '#8e24aa',
                        'bg-card': '#250841',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        /* Custom background gradient for the body */
        body {
            background: linear-gradient(135deg, #1e0538 0%, #0c0214 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Custom scrollbar for log section */
        #scan-log::-webkit-scrollbar {
            width: 8px;
        }
        #scan-log::-webkit-scrollbar-track {
            background: #1e0538;
            border-radius: 10px;
        }
        #scan-log::-webkit-scrollbar-thumb {
            background: #8e24aa;
            border-radius: 10px;
        }
        #scan-log::-webkit-scrollbar-thumb:hover {
            background: #e91e63;
        }
    </style>
</head>
<body class="text-white">
    <div id="app" class="w-full max-w-7xl px-4 py-8">
        <!-- App content will be rendered here -->
        <div id="loading-spinner" class="text-center text-gray-400">
            <p>Initializing application...</p>
        </div>
    </div>

    <!-- Firebase Libraries Module Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules globally for the main script to use
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, setLogLevel, signOut
        };
    </script>

    <script>
        // Global state object
        let state = {
            currentPage: 'login', // Start on the login page
            url: '',
            urlStatus: 'idle', // 'idle', 'valid', 'invalid'
            isUrlValidated: false,
            // UPDATED: Only show the requested modules
            scanModules: {
                sqlInjection: true,
                xssVulnerability: true,
                insecureHeaders: true,
                securityScore: true,
            },
            isScanning: false,
            scanProgress: 0,
            scanLog: [],
            reportData: null,
            maxLogLines: 20, // Limit log lines for performance
            
            // Auth State
            authReady: false,
            isLoggedIn: false, 
            userId: null,
            authMode: 'none', // 'guest', 'user', 'none'
        };

        // Firebase variables setup
        let app, db, auth;
        // Use global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Utility Functions ---

        const setState = (newState) => {
            state = { ...state, ...newState };
            renderApp();
        };

        const showMessageBox = (title, message) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-bg-card p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-accent-cyan/50 transform scale-105 transition duration-300">
                    <h3 class="text-xl font-bold text-accent-pink mb-4">${title}</h3>
                    <p class="text-gray-300 mb-6">${message}</p>
                    <button onclick="this.parentNode.parentNode.remove()" class="w-full py-2 bg-accent-cyan text-primary-dark font-bold rounded-full hover:bg-opacity-80 transition duration-200">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // --- Core Navigation and Auth ---

        const navigateTo = (page) => {
            // Prevent navigating to scan pages if not logged in and auth is ready
            const scanPages = ['start', 'configure', 'scanning', 'report'];
            if (scanPages.includes(page) && state.authReady && !state.isLoggedIn) {
                setState({ currentPage: 'login' });
                return;
            }
            setState({ currentPage: page });
        };

        const initializeFirebaseAndAuth = async () => {
            if (!firebaseConfig || !window.firebase) {
                console.error("Firebase resources missing. Cannot initialize.");
                setState({ authReady: true });
                return;
            }

            try {
                app = window.firebase.initializeApp(firebaseConfig);
                db = window.firebase.getFirestore(app);
                auth = window.firebase.getAuth(app);
                window.firebase.setLogLevel('debug');

                // Set up the listener first
                window.firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const currentAuthMode = user.isAnonymous ? 'guest' : 'user';
                        console.log(`User signed in: ${user.uid} (${currentAuthMode})`);
                        setState({
                            authReady: true,
                            isLoggedIn: true,
                            userId: user.uid,
                            authMode: currentAuthMode,
                        });
                        // Automatically move to start page after successful authentication
                        if (state.currentPage === 'login' || state.currentPage === 'register') {
                            navigateTo('start');
                        }
                    } else {
                        console.log("User signed out.");
                        setState({
                            authReady: true,
                            isLoggedIn: false,
                            userId: null,
                            authMode: 'none',
                        });
                        // Redirect to login if user logs out or session expires
                        if (state.currentPage !== 'login' && state.currentPage !== 'register') {
                            navigateTo('login');
                        }
                    }
                });

                // Attempt initial sign-in using provided token or anonymously (Guest)
                if (initialAuthToken) {
                    await window.firebase.signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await window.firebase.signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization or Sign-in Error:", error);
                // Fallback to unauthenticated state
                setState({ authReady: true, isLoggedIn: false, userId: null, authMode: 'none' });
            }
        };
        
        window.handleGuestLogin = async () => {
            // If already authenticated anonymously (which happens on load), just navigate.
            if (state.isLoggedIn && state.authMode === 'guest') {
                navigateTo('start');
                return;
            }
            // If not authenticated, force anonymous sign-in now.
            try {
                await window.firebase.signInAnonymously(auth);
                // onAuthStateChanged listener handles the state update and navigation
            } catch (error) {
                console.error("Error signing in anonymously:", error);
                showMessageBox("Error", "Could not sign in as guest. Please check your connection.");
            }
        };

        window.handleLogin = () => {
            // Placeholder: Use a message box instead of alert
            showMessageBox("Authentication Required", "Full user login/registration is not active in this demo. Please use the **Guest Login** option to proceed.");
        };

        window.handleRegister = () => {
            // Placeholder: Use a message box instead of alert
            showMessageBox("Registration Required", "Full user login/registration is not active in this demo. Please use the **Guest Login** option to proceed.");
        };

        window.handleLogout = async () => {
            try {
                await window.firebase.signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
                showMessageBox("Error", "Failed to log out.");
            }
        };

        // --- Scan Logic ---

        const simulateScan = () => {
            let progress = 0;
            const totalStepsPerModule = 5;
            const modules = Object.keys(state.scanModules).filter(v => state.scanModules[v]);
            const totalSteps = modules.length * totalStepsPerModule; 
            let currentStep = 0;

            const logEntry = (text, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                const newLog = [...state.scanLog, { time: timestamp, text: text, type: type }];
                setState({ scanLog: newLog.slice(-state.maxLogLines) });
            };

            const interval = setInterval(() => {
                if (progress >= 100) {
                    clearInterval(interval);
                    logEntry('Scan completed successfully. Generating Report.', 'success');
                    generateReport();
                    setState({ isScanning: false, currentPage: 'report' });
                    return;
                }

                currentStep++;
                progress = Math.min(100, Math.floor((currentStep / totalSteps) * 100));
                const moduleIndex = Math.floor((currentStep - 1) / totalStepsPerModule);
                const module = modules[moduleIndex];
                const moduleStep = (currentStep - 1) % totalStepsPerModule;


                if (moduleStep === 0) {
                    logEntry(`Starting module: ${module.split(/(?=[A-Z])/).join(' ')}`, 'module');
                } else if (moduleStep === 2) {
                    if (module !== 'securityScore') {
                        const isVulnerable = Math.random() > 0.7; 
                        logEntry(`Checking ${module}... ${isVulnerable ? 'Vulnerability found!' : 'No immediate risks detected.'}`, isVulnerable ? 'error' : 'info');
                    } else {
                         logEntry('Calculating overall security score...', 'module');
                    }
                } else {
                    logEntry(`Processing data... Progress: ${progress}%`);
                }

                setState({ scanProgress: progress });

            }, 500);
        };

        const generateReport = () => {
            const modules = Object.keys(state.scanModules).filter(key => state.scanModules[key]);
            
            let totalVulnerabilities = 0;
            
            const results = modules.map(module => {
                const name = module.split(/(?=[A-Z])/).map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');
                
                if (module === 'securityScore') {
                    // Special logic for Security Score
                    const score = Math.floor(Math.random() * 50) + 50; // Score between 50 and 99
                    const status = score >= 80 ? 'EXCELLENT' : (score >= 65 ? 'GOOD' : 'POOR');
                    const severity = score >= 80 ? 'Low' : (score >= 65 ? 'Medium' : 'High');
                    return {
                        name: 'Overall Security Score',
                        status: status,
                        severity: severity,
                        description: `The website received an overall security score of ${score}/100. This is based on a composite analysis of all active checks.`,
                        recommendation: `Focus on vulnerabilities identified in other sections to improve this score.`,
                        score: score
                    };
                } else {
                    // Logic for vulnerability modules
                    const isVulnerable = Math.random() > 0.4;
                    const status = isVulnerable ? 'VULNERABLE' : 'CLEAN';
                    if (isVulnerable) totalVulnerabilities++;
                    const severity = Math.random() > 0.8 ? 'High' : (Math.random() > 0.5 ? 'Medium' : 'Low');
                    
                    let description = '';
                    let recommendation = '';

                    if (module === 'sqlInjection') {
                        description = isVulnerable 
                            ? "Potential database exploitation risk through input fields. Check parameterized queries."
                            : "No immediate SQL Injection vectors found during automated testing.";
                        recommendation = isVulnerable
                            ? "Use parameterized queries (prepared statements) and escape all user input."
                            : "Maintain current secure coding practices.";
                    } else if (module === 'xssVulnerability') {
                        description = isVulnerable 
                            ? "Client-side script injection risk detected, potentially impacting user sessions."
                            : "Inputs appear to be properly sanitized against XSS attacks.";
                        recommendation = isVulnerable
                            ? "Ensure output encoding is applied to all user-controlled data before rendering."
                            : "Implement a Content Security Policy (CSP) for defense-in-depth.";
                    } else if (module === 'insecureHeaders') {
                        description = isVulnerable 
                            ? "Missing or misconfigured security headers (e.g., CSP, X-Frame-Options)."
                            : "HTTP security headers are appropriately configured.";
                        recommendation = isVulnerable
                            ? "Configure strong security headers on the web server (e.g., Strict-Transport-Security, X-Content-Type-Options)."
                            : "Regularly audit header configurations for best practices.";
                    }

                    return {
                        name: name,
                        status: status,
                        severity: severity,
                        description: description,
                        recommendation: recommendation,
                    };
                }
            });

            const overallStatus = totalVulnerabilities > 0 ? 'NEEDS ATTENTION' : 'ALL CLEAR';
            const overallSeverity = totalVulnerabilities > 2 ? 'CRITICAL' : (totalVulnerabilities > 0 ? 'WARNING' : 'SAFE');

            setState({
                reportData: {
                    targetUrl: state.url,
                    timestamp: new Date().toLocaleString(),
                    overallStatus: overallStatus,
                    overallSeverity: overallSeverity,
                    totalVulnerabilities: totalVulnerabilities,
                    results: results,
                }
            });
        };

        const downloadReportPdf = () => {
            // GUEST users are fully allowed to download the report
            const element = document.getElementById('report-content-container');
            const buttonContainer = document.querySelector('.report-actions-container'); // Use a class for consistency
            const originalDisplay = buttonContainer ? buttonContainer.style.display : 'flex';

            if (buttonContainer) {
                 // Hide buttons during PDF generation to prevent them from being included
                buttonContainer.style.display = 'none';
            }

            const options = {
                margin: 0.5,
                filename: `NIQAT_Al-Daef_Report_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Use html2pdf to generate and save the PDF
            html2pdf().set(options).from(element).save().then(() => {
                // Restore button visibility after saving
                if (buttonContainer) {
                    buttonContainer.style.display = originalDisplay;
                }
            });
        };

        // --- UI Rendering Helpers ---

        const renderAuthForm = (isLogin = true) => {
            const title = isLogin ? 'Log In' : 'Register';
            const actionText = isLogin ? 'Sign In' : 'Sign Up';
            const alternateText = isLogin ? 'Don\'t have an account?' : 'Already have an account?';
            const alternateAction = isLogin ? () => navigateTo('register') : () => navigateTo('login');
            const actionHandler = isLogin ? 'handleLogin()' : 'handleRegister()';

            return `
                <div class="max-w-md mx-auto bg-bg-card p-8 rounded-2xl shadow-2xl border border-accent-cyan/20 transform hover:scale-[1.01] transition duration-500">
                    <h1 class="text-4xl font-extrabold text-center text-accent-cyan mb-2">NIQAT Al-Daef</h1>
                    <p class="text-center text-gray-400 mb-8">${title}</p>

                    <form onsubmit="event.preventDefault(); ${actionHandler};" class="space-y-6">
                        <input type="email" placeholder="Email Address" required
                               class="w-full p-4 bg-primary-dark border-2 border-accent-purple rounded-lg text-white placeholder-gray-500 focus:ring-accent-pink focus:border-accent-pink transition duration-300">
                        <input type="password" placeholder="Password" required
                               class="w-full p-4 bg-primary-dark border-2 border-accent-purple rounded-lg text-white placeholder-gray-500 focus:ring-accent-pink focus:border-accent-pink transition duration-300">
                        
                        <button type="submit"
                            class="w-full py-4 text-xl font-bold rounded-lg shadow-xl transition duration-300 bg-accent-pink hover:bg-opacity-90 text-white transform hover:scale-[1.02] focus:ring-4 focus:ring-accent-pink focus:ring-opacity-50">
                            ${actionText}
                        </button>
                    </form>

                    <div class="mt-6 text-center">
                        <p class="text-gray-400">${alternateText} 
                            <a href="#" onclick="event.preventDefault(); navigateTo('${isLogin ? 'register' : 'login'}')" 
                               class="text-accent-cyan font-semibold hover:text-accent-pink transition duration-200">
                                ${isLogin ? 'Register' : 'Log In'}
                            </a>
                        </p>
                    </div>

                    <div class="mt-8 border-t border-gray-700 pt-6">
                        <button onclick="handleGuestLogin()"
                            class="w-full py-3 bg-accent-purple text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-300 focus:ring-4 focus:ring-accent-purple focus:ring-opacity-50 flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM12 14v4l-3-3m-3-3h-2a2 2 0 00-2 2v4a2 2 0 002 2h6a2 2 0 002-2v-4a2 2 0 00-2-2h-2"></path></svg>
                            Continue as Guest
                        </button>
                    </div>
                </div>
            `;
        };
        
        const generateReportView = (data) => {
            if (!data) return '';

            const statusColor = (status) => {
                switch (status) {
                    case 'CRITICAL': return 'bg-red-700';
                    case 'WARNING': return 'bg-yellow-600';
                    case 'SAFE': return 'bg-green-600';
                    case 'VULNERABLE': return 'text-red-400';
                    case 'CLEAN': return 'text-green-400';
                    case 'EXCELLENT': return 'text-green-400';
                    case 'GOOD': return 'text-yellow-400';
                    case 'POOR': return 'text-red-400';
                    default: return 'bg-gray-500';
                }
            };

            const severityBadge = (severity) => {
                switch (severity) {
                    case 'High': return 'bg-red-500';
                    case 'Medium': return 'bg-yellow-500';
                    case 'Low': return 'bg-green-500';
                    default: return 'bg-gray-500';
                }
            };

            const resultsHtml = data.results.map(result => `
                <div class="border-t border-accent-purple pt-4 mt-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-accent-cyan">${result.name}</h3>
                        <span class="text-sm font-medium ${statusColor(result.status)}">${result.status}${result.score !== undefined ? ` (${result.score}/100)` : ''}</span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm mt-1">
                        <span class="font-bold">Severity:</span>
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${severityBadge(result.severity)}">${result.severity}</span>
                    </div>
                    <p class="text-gray-300 mt-2">${result.description}</p>
                    <p class="text-accent-pink mt-1 italic">Recommendation: ${result.recommendation}</p>
                </div>
            `).join('');
            
            // NEW: Professional header for the PDF document
            const reportHeader = `
                <div class="text-center pb-6 mb-4 border-b border-gray-600">
                    <h1 class="text-4xl font-extrabold text-accent-pink">NIQAT Al-Daef Security Scan Report</h1>
                    <p class="text-gray-400 mt-2">Generated for: <span class="font-mono text-accent-cyan break-all">${data.targetUrl}</span> on ${data.timestamp}</p>
                </div>
            `;

            return `
                ${reportHeader}
                <div class="report-summary pb-4 border-b border-gray-700">
                    <div class="p-4 rounded-lg flex justify-between items-center ${statusColor(data.overallSeverity)} shadow-md">
                        <p class="text-lg font-bold">Overall Status: ${data.overallStatus}</p>
                        <p class="text-lg font-bold">Severity: ${data.overallSeverity}</p>
                        <p class="text-lg font-bold">Total Vulnerabilities: ${data.totalVulnerabilities}</p>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-accent-pink mt-6 mb-4">Detailed Findings</h2>
                <div id="detailed-results">
                    ${resultsHtml}
                </div>
            `;
        };

        // --- Main UI Renderer ---

        const renderApp = () => {
            const appDiv = document.getElementById('app');
            let content = '';

            // Loading screen while auth is setting up
            if (!state.authReady) {
                 appDiv.innerHTML = `
                    <div class="text-center mt-20">
                        <h1 class="text-4xl font-extrabold text-accent-cyan animate-pulse">NIQAT Al-Daef</h1>
                        <p class="text-gray-400 mt-4">Securing connection and preparing environment...</p>
                    </div>
                `;
                return;
            }

            // Status badge for URL input
            const urlBadge = (status) => {
                switch (status) {
                    case 'valid': return '<span class="px-3 py-1 bg-green-500 text-white rounded-full text-sm font-semibold">Valid</span>';
                    case 'invalid': return '<span class="px-3 py-1 bg-red-500 text-white rounded-full text-sm font-semibold">Invalid URL</span>';
                    default: return '';
                }
            };

            // Style for module toggles
            const toggleStyle = (isEnabled) => isEnabled
                ? 'bg-accent-purple text-white'
                : 'bg-primary-dark text-gray-400 border border-gray-700 hover:bg-gray-800';

            // Top Navigation (visible on scan/report pages)
            const topNav = state.isLoggedIn && (state.currentPage !== 'login' && state.currentPage !== 'register') ? `
                <div class="absolute top-4 right-4 flex items-center space-x-3 text-sm">
                    <span class="text-gray-400">User ID: <span class="font-mono text-accent-cyan">${state.userId.slice(0, 8)}...</span></span>
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${state.authMode === 'guest' ? 'bg-yellow-600' : 'bg-green-600'}">${state.authMode.toUpperCase()}</span>
                    <button onclick="handleLogout()" class="px-3 py-1 bg-gray-700 text-white rounded-full hover:bg-gray-600 transition">
                        Logout
                    </button>
                </div>
            ` : '';

            switch (state.currentPage) {
                case 'login':
                    content = renderAuthForm(true);
                    break;
                case 'register':
                    content = renderAuthForm(false);
                    break;
                case 'start':
                    content = `
                        ${topNav}
                        <div class="max-w-xl mx-auto bg-bg-card p-8 rounded-2xl shadow-2xl border border-accent-cyan/20 transform hover:scale-[1.01] transition duration-500">
                            <h1 class="text-4xl font-extrabold text-center text-accent-cyan mb-2">NIQAT Al-Daef</h1>
                            <p class="text-center text-gray-400 mb-8">Web Security Scanning Tool</p>

                            <div class="space-y-6">
                                <label for="url-input" class="block text-lg font-medium text-gray-300">Target URL</label>
                                <div class="relative flex items-center">
                                    <input type="url" id="url-input" placeholder="e.g., https://example.com"
                                           value="${state.url}" oninput="validateUrl(event.target.value)"
                                           class="w-full p-4 pr-28 bg-primary-dark border-2 ${state.urlStatus === 'invalid' ? 'border-red-500' : 'border-accent-purple'} rounded-full text-white placeholder-gray-500 focus:ring-accent-cyan focus:border-accent-cyan transition duration-300">
                                    <div class="absolute right-3">
                                        ${urlBadge(state.urlStatus)}
                                    </div>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Enter the full URL, including 'http://' or 'https://'.</p>
                            </div>

                            <button onclick="navigateTo('configure')" ${!state.isUrlValidated ? 'disabled' : ''}
                                class="mt-8 w-full py-4 text-xl font-bold rounded-full shadow-xl transition duration-300
                                ${state.isUrlValidated
                                    ? 'bg-accent-pink hover:bg-opacity-90 text-white transform hover:scale-105 focus:ring-4 focus:ring-accent-pink focus:ring-opacity-50'
                                    : 'bg-gray-700 text-gray-400 cursor-not-allowed'
                                }">
                                Configure Scan
                            </button>
                        </div>
                    `;
                    break;

                case 'configure':
                    content = `
                        ${topNav}
                        <div class="max-w-2xl mx-auto bg-bg-card p-8 rounded-2xl shadow-2xl border border-accent-cyan/20">
                            <h2 class="text-3xl font-bold text-accent-cyan mb-2">Scan Configuration</h2>
                            <p class="text-gray-400 mb-6">Target: <span class="font-mono text-accent-pink break-all">${state.url}</span></p>

                            <h3 class="text-2xl font-semibold text-gray-200 mb-4 border-b border-accent-purple pb-2">Select Modules</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${Object.keys(state.scanModules).map(key => `
                                    <button onclick="toggleModule('${key}')"
                                            class="p-4 rounded-xl text-left transition duration-200 flex items-center justify-between ${toggleStyle(state.scanModules[key])}">
                                        <span class="font-medium">${key.split(/(?=[A-Z])/).map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}</span>
                                        ${state.scanModules[key]
                                            ? '<svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                                            : '<svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'
                                        }
                                    </button>
                                `).join('')}
                            </div>

                            <div class="mt-8 flex justify-between space-x-4">
                                <button onclick="navigateTo('start')"
                                    class="w-1/3 py-3 bg-gray-600 text-white font-semibold rounded-full shadow-lg hover:bg-gray-500 transition duration-300">
                                    &larr; Back
                                </button>
                                <button onclick="startScan()"
                                    class="w-2/3 py-3 bg-accent-pink text-white font-bold rounded-full shadow-xl hover:bg-opacity-90 transition duration-300 transform hover:scale-[1.02] focus:ring-4 focus:ring-accent-pink focus:ring-opacity-50">
                                    Start Scan
                                </button>
                            </div>
                        </div>
                    `;
                    break;

                case 'scanning':
                    const progressStyle = `width: ${state.scanProgress}%`;
                    content = `
                        ${topNav}
                        <div class="max-w-3xl mx-auto bg-bg-card p-8 rounded-2xl shadow-2xl border border-accent-cyan/20">
                            <h2 class="text-3xl font-bold text-accent-cyan mb-2 text-center">Scanning in Progress...</h2>
                            <p class="text-center text-gray-400 mb-6">Target: <span class="font-mono text-accent-pink break-all">${state.url}</span></p>

                            <!-- Progress Bar -->
                            <div class="w-full bg-primary-dark rounded-full h-4 mb-6 shadow-inner">
                                <div class="h-4 rounded-full bg-gradient-to-r from-accent-cyan to-accent-purple transition-all duration-1000" style="${progressStyle}"></div>
                            </div>
                            <p class="text-xl font-bold text-center text-accent-pink mb-6">${state.scanProgress}% Complete</p>

                            <!-- Scan Log -->
                            <div class="h-64 bg-primary-dark p-4 rounded-xl overflow-y-auto font-mono text-sm" id="scan-log">
                                ${state.scanLog.map(log => {
                                    let color = 'text-gray-300';
                                    if (log.type === 'error') color = 'text-red-400';
                                    if (log.type === 'success') color = 'text-green-400';
                                    if (log.type === 'module') color = 'text-accent-cyan';
                                    return `<p class="${color}">[${log.time}] ${log.text}</p>`;
                                }).join('')}
                            </div>
                            ${state.scanLog.length >= state.maxLogLines ? '<p class="text-center text-sm text-gray-500 mt-2">Displaying last ' + state.maxLogLines + ' log lines.</p>' : ''}
                        </div>
                    `;
                    break;

                case 'report':
                    if (state.reportData) {
                        content = `
                            ${topNav}
                            <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                                <h1 class="text-3xl font-bold text-accent-cyan mb-6 text-center">Scan Complete: Report Overview</h1>

                                <!-- Report Content Section (The target for PDF generation) -->
                                <div id="report-content-container" class="bg-bg-card p-6 rounded-xl shadow-2xl space-y-4 mb-8">
                                    ${generateReportView(state.reportData)}
                                </div>

                                <!-- Download Button Section (Now placed below the report content) -->
                                <div class="flex justify-center space-x-4 report-actions-container">
                                    <button onclick="downloadReportPdf()"
                                        class="flex items-center px-6 py-3 bg-accent-purple text-white font-semibold rounded-full shadow-lg hover:bg-opacity-90 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-accent-purple focus:ring-opacity-50">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v7a1 1 0 11-2 0V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                                        Download Report (PDF)
                                    </button>
                                    <button onclick="navigateTo('start')"
                                        class="flex items-center px-6 py-3 bg-gray-600 text-white font-semibold rounded-full shadow-lg hover:bg-gray-500 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-600 focus:ring-opacity-50">
                                        Start New Scan
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        content = `
                            ${topNav}
                            <div class="max-w-md mx-auto bg-bg-card p-8 rounded-2xl shadow-2xl text-center">
                                <p class="text-red-400 text-xl">Error: No report data found.</p>
                                <button onclick="navigateTo('start')" class="mt-6 py-2 px-4 bg-accent-pink text-white rounded-full">Start New Scan</button>
                            </div>
                        `;
                    }
                    break;
            }

            appDiv.innerHTML = content;

            // Scroll log to bottom on update if on scanning page
            if (state.currentPage === 'scanning') {
                const logDiv = document.getElementById('scan-log');
                if (logDiv) {
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
            }
        };

        // --- Event Handlers & Initializers ---

        window.validateUrl = (url) => {
            const urlRegex = /^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i;
            const isValidFormat = urlRegex.test(url);

            setState({ url: url });

            if (isValidFormat) {
                setState({ urlStatus: 'valid', isUrlValidated: true });
            } else if (url.length === 0) {
                setState({ urlStatus: 'idle', isUrlValidated: false });
            } else {
                setState({ urlStatus: 'invalid', isUrlValidated: false });
            }
        };

        window.toggleModule = (moduleKey) => {
            setState({
                scanModules: {
                    ...state.scanModules,
                    [moduleKey]: !state.scanModules[moduleKey],
                }
            });
        };

        window.startScan = () => {
            if (!state.isScanning) {
                if (Object.values(state.scanModules).some(v => v)) {
                    setState({
                        isScanning: true,
                        scanLog: [],
                        scanProgress: 0,
                        reportData: null,
                        currentPage: 'scanning',
                    });
                    setTimeout(simulateScan, 500);
                } else {
                    showMessageBox("Module Selection", "Please select at least one scan module before starting the scan.");
                }
            }
        };

        window.downloadReportPdf = downloadReportPdf;
        window.navigateTo = navigateTo; // Expose global navigation function
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleGuestLogin = handleGuestLogin;
        window.handleLogout = handleLogout;


        // Initial setup on load
        document.addEventListener('DOMContentLoaded', () => {
             // Wait for the window.firebase object to be available from the module script
            const checkFirebase = setInterval(() => {
                if (window.firebase) {
                    clearInterval(checkFirebase);
                    initializeFirebaseAndAuth();
                }
            }, 100);
            renderApp();
        });

    </script>
</body>
</html>
