<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIQAT Al-Daef - Security Scanner</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load html2pdf.js for generating reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Configure Tailwind to use custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e0538',
                        'accent-pink': '#e91e63',
                        'accent-cyan': '#00bcd4',
                        'accent-purple': '#8e24aa',
                        'bg-card': '#250841',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        /* Custom background gradient for the body */
        body {
            background: linear-gradient(135deg, #1e0538 0%, #0c0214 100%);
            min-height: 100vh;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e0538;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #8e24aa;
            border-radius: 20px;
            border: 2px solid #1e0538;
        }
        .scan-log-entry {
            transition: background-color 0.3s ease;
        }
        .scan-log-entry:hover {
            background-color: #2c0b4f;
        }
        /* Pulse animation for scanning status */
        .pulse-effect {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto py-8">
        <!-- Application content will be rendered here -->
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, // NEW: For saving user profile data
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set log level to see Firebase/Firestore logs
        setLogLevel('debug');

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Mandatory App ID

        
        // Global state management
        let state = {
            currentPage: 'auth', // Start on the authentication page
            isAuthenticated: false, // Tracks user login status
            authMode: 'login', // 'login' or 'register'
            authError: '',
            targetUrl: '',
            urlStatus: 'idle', // 'idle', 'valid', 'invalid'
            isUrlValidated: false,
            scanModules: {
                sqlInjection: true,
                xss: true,
                csrf: true,
                insecureHeaders: false,
                brokenAuthentication: false,
                sensitiveDataExposure: false,
            },
            isScanning: false,
            scanProgress: 0,
            scanLog: [],
            reportData: null,
            // New state field for user-specific data (e.g., full name)
            userProfile: { fullName: 'Guest', email: '' }
        };

        const moduleNames = {
            sqlInjection: 'SQL Injection Detection',
            xss: 'Cross-Site Scripting (XSS) Analysis',
            csrf: 'Cross-Site Request Forgery (CSRF) Check',
            insecureHeaders: 'Insecure HTTP Headers Check',
            brokenAuthentication: 'Broken Authentication/Session',
            sensitiveDataExposure: 'Sensitive Data Exposure',
        };

        const moduleSeverities = {
            sqlInjection: 'Critical',
            xss: 'High',
            csrf: 'Medium',
            insecureHeaders: 'Low',
            brokenAuthentication: 'Critical',
            sensitiveDataExposure: 'High',
        };

        // State Functions
        function setState(newState) {
            state = { ...state, ...newState };
            renderApp();
        }

        // Navigation
        function navigateTo(page) {
            // Prevent navigation to main app pages if not authenticated
            if (page !== 'auth' && !state.isAuthenticated) {
                return;
            }
            if (page === 'configure' && !state.isUrlValidated) {
                return;
            }
            if (page === 'report' && !state.reportData) {
                return;
            }
            setState({ currentPage: page });
        }

        // --- FIREBASE / FIRESTORE LOGIC ---
        
        /**
         * Saves additional user profile data to Firestore after successful registration.
         * The document ID is the user's UID, ensuring secure linkage.
         * Path: /artifacts/{appId}/users/{userId}/user_profile/main
         */
        async function saveNewUserProfile(user, name, email) {
            if (!db || !user) return;
            
            // Constructs the document reference in the private user collection
            const userDocRef = doc(db, 
                `artifacts/${appId}/users/${user.uid}/user_profile/main`
            );

            try {
                await setDoc(userDocRef, {
                    fullName: name,
                    email: email,
                    registrationDate: new Date().toISOString(),
                    // Add any other default user settings or roles here
                }, { merge: true });
                console.log(`[Firestore] User profile created for: ${user.uid}`);
            } catch (error) {
                // Log the error but don't disrupt the user experience as Auth was successful
                console.error("[Firestore] Error saving user profile to Firestore:", error);
            }
        }


        async function initializeFirebase() {
            try {
                // Mandatory global variables for Canvas environment
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration is missing.");
                    return;
                }

                // Initialize services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Sign in using the initial custom token or anonymously
                // This ensures we have a valid auth context before listening for changes
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log(`[Auth] User authenticated: ${userId}. Is anonymous: ${user.isAnonymous}`);
                        
                        let profile = { fullName: user.isAnonymous ? 'Guest User' : 'Registered User', email: user.email || '' };
                        
                        // NOTE: If you wanted to fetch the 'fullName' saved above, 
                        // you would add a getDoc call here, but for now we only set a placeholder.
                        
                        if (!state.isAuthenticated) {
                            setState({ 
                                isAuthenticated: true, 
                                authError: '', 
                                currentPage: 'home',
                                userProfile: profile
                            });
                        }
                    } else {
                        userId = null;
                        console.log("[Auth] User signed out.");
                        // Redirect to auth page if signed out
                        setState({ 
                            isAuthenticated: false, 
                            currentPage: 'auth',
                            userProfile: { fullName: 'Guest', email: '' } 
                        });
                    }
                });
            } catch (error) {
                console.error("[Auth] Firebase initialization or initial sign-in failed:", error);
                setState({ isAuthenticated: false, authError: `Initialization failed. Error: ${error.message}` });
            }
        }
        
        async function handleAuthAction(event) {
            event.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            // NEW: Get the full name only if the user is registering
            const fullName = state.authMode === 'register' ? document.getElementById('auth-full-name').value : null;

            setState({ authError: '' }); // Clear previous errors

            if (!email || !password || (state.authMode === 'register' && !fullName)) {
                setState({ authError: "All fields are required." });
                return;
            }

            try {
                if (state.authMode === 'register') {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // *** CRITICAL STEP: SAVE ADDITIONAL USER DATA TO FIRESTORE ***
                    await saveNewUserProfile(userCredential.user, fullName, email);
                    // AuthStateChanged listener handles the state update and navigation
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    // AuthStateChanged listener handles the state update and navigation
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                // Display a user-friendly error message
                let errorMessage = "An unknown error occurred.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already registered.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Invalid email or password.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password should be at least 6 characters.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else {
                    errorMessage = error.message.replace('Firebase: Error (auth/', '').replace(').', '');
                }
                setState({ authError: errorMessage });
            }
        }

        async function handleGuestLogin() {
            try {
                setState({ authError: '' });
                await signInAnonymously(auth);
                // AuthStateChanged listener handles the state update and navigation
            } catch (error) {
                console.error("Guest Login Error:", error);
                setState({ authError: `Guest login failed. ${error.message}` });
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                // AuthStateChanged listener handles the state update and navigation
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        }

        function setAuthMode(mode) {
            setState({ authMode: mode, authError: '' });
        }


        // --- UI RENDERING COMPONENTS ---

        function renderHeader() {
            return `
                <header class="text-center mb-10">
                    <h1 class="text-5xl font-extrabold text-accent-cyan tracking-tight mb-2">
                        NIQAT Al-Daef
                    </h1>
                    <p class="text-xl text-accent-pink">
                        Web Security Scanner & Vulnerability Analysis
                    </p>
                    ${state.isAuthenticated ? `<p class="text-xs text-gray-400 mt-2">User ID: <span class="font-mono text-accent-purple break-all">${userId}</span></p>` : ''}
                </header>
            `;
        }

        function renderNavigation() {
            if (!state.isAuthenticated) return '';

            const tabs = [
                { id: 'home', label: 'Dashboard' },
                { id: 'configure', label: 'Configure Scan' },
                { id: 'report', label: 'View Report' },
            ];

            return `
                <nav class="bg-bg-card p-2 rounded-xl shadow-lg mb-8 flex flex-wrap justify-center space-x-2 sm:space-x-4">
                    ${tabs.map(tab => `
                        <button 
                            onclick="navigateTo('${tab.id}')"
                            class="px-4 py-2 text-sm font-medium rounded-lg transition duration-300 ease-in-out ${state.currentPage === tab.id ? 'bg-accent-purple text-white shadow-md' : 'text-gray-400 hover:text-white hover:bg-[#3d0f66]'}"
                            ${(tab.id === 'configure' && !state.isUrlValidated && state.currentPage !== 'configure') || (tab.id === 'report' && !state.reportData && state.currentPage !== 'report') ? 'disabled opacity-50 cursor-not-allowed' : ''}
                        >
                            ${tab.label}
                        </button>
                    `).join('')}
                    <button 
                        onclick="handleSignOut()"
                        class="px-4 py-2 text-sm font-medium rounded-lg transition duration-300 ease-in-out text-red-400 hover:text-white hover:bg-red-700 ml-4"
                    >
                        Sign Out
                    </button>
                </nav>
            `;
        }

        function renderAuthPage() {
            const isLogin = state.authMode === 'login';
            
            return `
                <div class="max-w-md mx-auto bg-bg-card p-8 rounded-xl shadow-2xl border-t-4 border-accent-pink space-y-6">
                    <h2 class="text-3xl font-bold text-accent-pink text-center mb-6">
                        ${isLogin ? 'Welcome Back!' : 'Create Account'}
                    </h2>
                    
                    ${state.authError ? `
                        <div class="p-3 bg-red-900/40 border border-red-700 rounded-lg text-red-300 text-sm">
                            ${state.authError}
                        </div>
                    ` : ''}

                    <form onsubmit="handleAuthAction(event)" class="space-y-4">
                        ${!isLogin ? `
                            <div>
                                <label for="auth-full-name" class="block text-sm font-medium text-gray-400 mb-1">Full Name</label>
                                <input 
                                    type="text"
                                    id="auth-full-name"
                                    required
                                    placeholder="Your Name"
                                    class="w-full p-3 bg-primary-dark border-2 border-primary-dark focus:border-accent-purple rounded-lg focus:outline-none transition duration-300 ease-in-out text-white placeholder-gray-500 shadow-inner"
                                />
                            </div>
                        ` : ''}
                        <div>
                            <label for="auth-email" class="block text-sm font-medium text-gray-400 mb-1">Email Address</label>
                            <input 
                                type="email"
                                id="auth-email"
                                required
                                placeholder="you@example.com"
                                class="w-full p-3 bg-primary-dark border-2 border-primary-dark focus:border-accent-purple rounded-lg focus:outline-none transition duration-300 ease-in-out text-white placeholder-gray-500 shadow-inner"
                            />
                        </div>

                        <div>
                            <label for="auth-password" class="block text-sm font-medium text-gray-400 mb-1">Password (min. 6 characters)</label>
                            <input 
                                type="password"
                                id="auth-password"
                                required
                                placeholder="********"
                                class="w-full p-3 bg-primary-dark border-2 border-primary-dark focus:border-accent-purple rounded-lg focus:outline-none transition duration-300 ease-in-out text-white placeholder-gray-500 shadow-inner"
                            />
                        </div>

                        <button 
                            type="submit"
                            class="w-full py-3 mt-4 text-lg font-bold rounded-lg transition duration-300 bg-accent-pink hover:bg-accent-purple shadow-md"
                        >
                            ${isLogin ? 'Log In' : 'Register'}
                        </button>
                    </form>

                    <div class="text-center text-sm text-gray-400">
                        ${isLogin ? 'New user? ' : 'Already have an account? '}
                        <button onclick="setAuthMode('${isLogin ? 'register' : 'login'}')" class="text-accent-cyan hover:text-white font-semibold transition duration-200">
                            ${isLogin ? 'Create an Account' : 'Log In Here'}
                        </button>
                    </div>
                    
                    <div class="flex items-center">
                        <div class="flex-grow border-t border-gray-700"></div>
                        <span class="flex-shrink mx-4 text-gray-500 text-sm">OR</span>
                        <div class="flex-grow border-t border-gray-700"></div>
                    </div>
                    
                    <button 
                        onclick="handleGuestLogin()"
                        class="w-full py-3 text-lg font-bold rounded-lg transition duration-300 bg-gray-600 hover:bg-gray-700 shadow-md text-white"
                    >
                        Log In as Guest
                    </button>
                </div>
            `;
        }
        
        // --- EXISTING PAGES (Updated) ---

        function renderHomePage() {
            if (!state.isAuthenticated) return renderAuthPage(); // Security guard

            const urlIconClass = state.urlStatus === 'valid' ? 'text-green-500' : state.urlStatus === 'invalid' ? 'text-red-500' : 'text-gray-500';

            return `
                <div class="space-y-6">
                    <div class="bg-bg-card p-6 rounded-xl shadow-2xl border-t-4 border-accent-cyan">
                        <h2 class="text-2xl font-bold mb-4 text-accent-cyan flex items-center">
                            Welcome, ${state.userProfile.fullName}!
                        </h2>
                        <p class="text-gray-400 mb-4">
                            Ready to secure a new website? Enter the URL below to begin configuration.
                        </p>
                        <h3 class="text-xl font-semibold mb-4 text-gray-300 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.1-1.1"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.9 5.7L18.8 6.8c1.6 1.6 1.6 4.1 0 5.7l-4 4c-1.6 1.6-4.1 1.6-5.7 0l-1.1-1.1"/>
                            </svg>
                            Target URL
                        </h3>
                        <div class="relative flex items-center">
                            <input 
                                type="url"
                                id="target-url-input"
                                value="${state.targetUrl}"
                                oninput="handleUrlInput(this.value)"
                                placeholder="e.g., https://example.com"
                                class="w-full p-3 pr-10 bg-primary-dark border-2 border-primary-dark focus:border-accent-purple rounded-lg focus:outline-none transition duration-300 ease-in-out text-white placeholder-gray-500 shadow-inner"
                            />
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute right-3 ${urlIconClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                ${state.urlStatus === 'valid' 
                                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />' 
                                    : state.urlStatus === 'invalid' 
                                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />' 
                                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.1-1.1"/>'}
                            </svg>
                        </div>
                        ${state.urlStatus === 'invalid' ? `<p class="mt-2 text-sm text-red-400 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Invalid URL format. Please include protocol (e.g., https://).
                        </p>` : ''}
                    </div>

                    <div class="bg-bg-card p-6 rounded-xl shadow-2xl border-t-4 border-accent-pink">
                        <h2 class="text-2xl font-bold mb-4 text-accent-pink flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Scan Status
                        </h2>
                        ${state.reportData ? `
                            <p class="text-lg mb-4 text-green-400 font-semibold">
                                Scan Complete! Report available for ${state.targetUrl}.
                            </p>
                            <button onclick="navigateTo('report')" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition duration-300 shadow-lg">
                                View Full Report
                            </button>
                        ` : state.isScanning ? `
                            <p class="text-lg mb-4 text-accent-cyan font-semibold pulse-effect">
                                Scan in Progress... (${state.scanProgress.toFixed(0)}%)
                            </p>
                            <button class="w-full py-3 bg-gray-600 rounded-lg font-semibold cursor-not-allowed opacity-70">
                                Scanning...
                            </button>
                        ` : state.isUrlValidated ? `
                            <p class="text-lg mb-4 text-gray-300">
                                Target validated. Ready to configure and start scan.
                            </p>
                            <button onclick="navigateTo('configure')" class="w-full py-3 bg-accent-purple hover:bg-accent-pink rounded-lg font-semibold transition duration-300 shadow-lg">
                                Start Configuration
                            </button>
                        ` : `
                            <p class="text-lg mb-4 text-gray-400">
                                Enter a valid target URL above to proceed.
                            </p>
                            <button class="w-full py-3 bg-gray-600 rounded-lg font-semibold cursor-not-allowed opacity-70">
                                Enter URL
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        function renderConfigurePage() {
            if (!state.isAuthenticated) return renderAuthPage(); // Security guard

            const moduleList = Object.keys(state.scanModules);
            const selectedCount = moduleList.filter(key => state.scanModules[key]).length;

            return `
                <div class="bg-bg-card p-6 rounded-xl shadow-2xl border-t-4 border-accent-purple space-y-6">
                    <h2 class="text-3xl font-bold mb-4 text-accent-purple flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.246.608 3.242 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Select Vulnerability Modules
                    </h2>

                    <p class="text-gray-300">Target: <span class="font-mono text-accent-cyan break-all">${state.targetUrl}</span></p>
                    <p class="text-sm text-gray-400">Selected Modules: <span class="font-bold text-accent-pink">${selectedCount}</span></p>

                    <div class="grid md:grid-cols-2 gap-4">
                        ${moduleList.map(key => `
                            <div class="p-4 bg-primary-dark rounded-lg shadow-md flex justify-between items-center transition duration-300 ${state.scanModules[key] ? 'border-l-4 border-accent-pink' : 'border-l-4 border-transparent hover:border-accent-cyan'}">
                                <div>
                                    <p class="font-semibold text-white">${moduleNames[key]}</p>
                                    <span class="text-xs text-gray-400">Severity: ${moduleSeverities[key]}</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" class="sr-only peer" ${state.scanModules[key] ? 'checked' : ''} onclick="toggleModule('${key}')">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent-cyan rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-pink"></div>
                                </label>
                            </div>
                        `).join('')}
                    </div>

                    <button 
                        onclick="startScan()" 
                        ${selectedCount === 0 ? 'disabled' : ''}
                        class="w-full py-4 mt-6 text-xl font-bold rounded-lg transition duration-300 ease-in-out ${selectedCount === 0 ? 'bg-gray-600 opacity-50 cursor-not-allowed' : 'bg-accent-cyan hover:bg-accent-pink shadow-lg shadow-accent-cyan/50'}"
                    >
                        Start Scan Now
                    </button>
                </div>
            `;
        }

        function renderScanningPage() {
            if (!state.isAuthenticated) return renderAuthPage(); // Security guard

            return `
                <div class="bg-bg-card p-6 rounded-xl shadow-2xl border-t-4 border-accent-cyan space-y-6">
                    <h2 class="text-3xl font-bold text-accent-cyan flex items-center mb-4 pulse-effect">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Scanning in Progress...
                    </h2>

                    <p class="text-gray-300">Target: <span class="font-mono text-accent-cyan break-all">${state.targetUrl}</span></p>

                    <!-- Progress Bar -->
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div>
                                <span class="text-xs font-semibold inline-block py-1 px-3 uppercase rounded-full text-accent-pink bg-[#3d0f66]">
                                    Progress
                                </span>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-semibold inline-block text-accent-cyan">
                                    ${state.scanProgress.toFixed(0)}%
                                </span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-3 mb-4 text-xs flex rounded bg-primary-dark">
                            <div style="width:${state.scanProgress}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-accent-pink transition-all duration-700 ease-in-out"></div>
                        </div>
                    </div>

                    <!-- Scan Log -->
                    <div class="h-96 bg-primary-dark rounded-lg p-3 overflow-y-scroll custom-scrollbar text-sm font-mono border border-gray-700">
                        ${state.scanLog.map((log, index) => `
                            <div class="scan-log-entry p-1 rounded-sm flex justify-between">
                                <span class="text-gray-500">${new Date(log.timestamp).toLocaleTimeString()}</span>
                                <span class="${log.status === 'ERROR' ? 'text-red-400' : log.status === 'SUCCESS' ? 'text-green-400' : 'text-gray-300'}">${log.message}</span>
                            </div>
                        `).join('')}
                    </div>

                    <p class="text-center text-gray-500 text-sm italic mt-4">
                        Do not close this window during the scan.
                    </p>
                </div>
            `;
        }
        
        function renderReportPage() {
            if (!state.isAuthenticated) return renderAuthPage(); // Security guard

            if (!state.reportData) {
                return `
                    <div class="bg-bg-card p-6 rounded-xl shadow-2xl border-t-4 border-red-500 space-y-4 text-center">
                        <h2 class="text-3xl font-bold text-red-400">No Scan Report Available</h2>
                        <p class="text-gray-400">Please run a scan first from the <button onclick="navigateTo('home')" class="text-accent-cyan hover:underline">Dashboard</button> or <button onclick="navigateTo('configure')" class="text-accent-pink hover:underline">Configure Scan</button> page.</p>
                    </div>
                `;
            }

            const report = state.reportData;
            const issueSeverityColors = {
                Critical: 'border-red-600 bg-red-900/20 text-red-400',
                High: 'border-orange-500 bg-orange-900/20 text-orange-400',
                Medium: 'border-yellow-400 bg-yellow-900/20 text-yellow-400',
                Low: 'border-green-500 bg-green-900/20 text-green-400',
            };

            const issueIcon = (severity) => {
                switch(severity) {
                    case 'Critical': return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                    case 'High': return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM5 8a2 2 0 11-4 0 2 2 0 014 0zM12 15h2V6h-2v9zM6 15h2V6H6v9zM11 15h-2V6h2v9z" /></svg>`;
                    case 'Medium': return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.427 2.67-1.427 3.434 0L15.65 10H4.35l3.907-6.901zM10 13a1 1 0 110 2 1 1 0 010-2z" clip-rule="evenodd" /></svg>`;
                    case 'Low': return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.042a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.042a1 1 0 00-1.175 0l-2.817 2.042c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.05 8.72a1 1 0 01.588-1.81h3.461a1 1 0 00.95-.69l1.07-3.292z" /></svg>`;
                    default: return '';
                }
            };

            const totalIssues = report.issues.length;
            const criticalIssues = report.issues.filter(i => i.severity === 'Critical').length;
            const highIssues = report.issues.filter(i => i.severity === 'High').length;
            
            return `
                <div id="report-content" class="space-y-8">
                    <!-- Report Header -->
                    <div class="bg-primary-dark p-6 rounded-xl shadow-2xl border-t-4 border-accent-purple">
                        <h2 class="text-3xl font-bold text-accent-cyan mb-2">Security Scan Report</h2>
                        <p class="text-lg text-gray-300">Target URL: <span class="font-mono text-accent-pink break-all">${report.targetUrl}</span></p>
                        <p class="text-sm text-gray-400">Scan Date: ${new Date(report.scanDate).toLocaleDateString()} at ${new Date(report.scanDate).toLocaleTimeString()}</p>
                    </div>

                    <!-- Summary Metrics -->
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="bg-bg-card p-4 rounded-xl shadow-lg border-l-4 border-gray-400">
                            <p class="text-sm text-gray-400">Total Modules</p>
                            <p class="text-2xl font-bold text-white">${report.modulesScanned.length}</p>
                        </div>
                        <div class="bg-bg-card p-4 rounded-xl shadow-lg border-l-4 border-red-600">
                            <p class="text-sm text-gray-400">Critical / High Issues</p>
                            <p class="text-2xl font-bold text-red-400">${criticalIssues + highIssues} / ${totalIssues}</p>
                        </div>
                        <div class="bg-bg-card p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                            <p class="text-sm text-gray-400">Scan Duration</p>
                            <p class="text-2xl font-bold text-white">${(report.durationMs / 1000).toFixed(1)}s</p>
                        </div>
                    </div>

                    <!-- Issues Detailed List -->
                    <div class="bg-bg-card p-6 rounded-xl shadow-2xl border-t-4 border-accent-pink">
                        <h3 class="text-2xl font-bold text-accent-pink mb-4">Vulnerability Findings (${totalIssues} Total)</h3>
                        
                        ${totalIssues === 0 ? `
                            <div class="p-4 text-center bg-green-900/30 rounded-lg text-green-400 font-semibold">
                                ðŸŽ‰ Congratulations! No major vulnerabilities were found by the selected modules.
                            </div>
                        ` : report.issues.map(issue => `
                            <div class="p-4 mb-4 rounded-lg border-l-4 ${issueSeverityColors[issue.severity]} transition-all duration-300">
                                <h4 class="text-xl font-bold mb-1 flex items-center">
                                    ${issueIcon(issue.severity)}
                                    ${issue.name}
                                </h4>
                                <p class="text-sm text-gray-300 mb-2">
                                    <span class="font-semibold">${issue.severity}</span> - Found in module: ${issue.module}
                                </p>
                                <p class="text-sm text-gray-400 leading-relaxed">${issue.description}</p>
                                <div class="mt-2 pt-2 border-t border-gray-700">
                                    <p class="text-xs text-gray-500 font-mono">
                                        <span class="font-semibold text-gray-400">Location:</span> ${issue.location || 'N/A'}
                                    </p>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Remediation Overview -->
                    <div class="bg-primary-dark p-6 rounded-xl shadow-2xl border-t-4 border-accent-cyan">
                        <h3 class="text-2xl font-bold text-accent-cyan mb-4">Recommended Actions</h3>
                        <ul class="space-y-3 list-disc list-inside text-gray-300">
                            <li>Prioritize fixing <span class="text-red-400 font-bold">Critical</span> and <span class="text-orange-400 font-bold">High</span> severity findings first.</li>
                            <li>For SQL Injection: Implement prepared statements or parameterized queries.</li>
                            <li>For XSS: Sanitize all user input and properly escape output content based on context.</li>
                            <li>For Insecure Headers: Ensure secure headers like \`Content-Security-Policy\`, \`X-Content-Type-Options\`, and \`Strict-Transport-Security\` are properly configured.</li>
                        </ul>
                    </div>

                    <!-- Download Button -->
                    <button onclick="downloadReportPdf()" class="w-full py-4 bg-accent-purple hover:bg-accent-pink rounded-lg font-bold text-xl transition duration-300 shadow-lg shadow-accent-purple/50">
                        Download Report as PDF
                    </button>
                </div>
            `;
        }

        // --- EXISTING UTILITY FUNCTIONS ---

        function handleUrlInput(url) {
            setState({ targetUrl: url });
            clearTimeout(window.urlValidationTimeout);
            window.urlValidationTimeout = setTimeout(() => validateUrl(url), 500);
        }

        function validateUrl(url) {
            const urlRegex = /^(https?:\/\/[^\s$.?#].[^\s]*)$/i;
            const isValidFormat = urlRegex.test(url);

            if (isValidFormat) {
                setState({ urlStatus: 'valid', isUrlValidated: true });
                if (state.currentPage === 'home') {
                    setTimeout(() => navigateTo('configure'), 700);
                }
            } else if (url.length === 0) {
                setState({ urlStatus: 'idle', isUrlValidated: false });
            } else {
                setState({ urlStatus: 'invalid', isUrlValidated: false });
            }
        }

        function toggleModule(moduleKey) {
            setState({
                scanModules: {
                    ...state.scanModules,
                    [moduleKey]: !state.scanModules[moduleKey],
                }
            });
        }

        function generateRandomIssue(moduleKey) {
            const severity = moduleSeverities[moduleKey];
            const issueName = moduleNames[moduleKey].replace(' Detection', '').replace(' Analysis', '').replace(' Check', '');
            const descriptions = [
                `Potential vulnerability detected. The scanner identified patterns consistent with ${issueName} in the input handling mechanisms.`,
                `A security weakness was observed. The application may be susceptible to ${issueName} due to improper sanitization of user-controlled data.`,
                `Security audit flag: Possible ${issueName} risk identified in a critical component. Immediate review is recommended.`,
                `The scan module for ${issueName} reported a finding. Ensure all user-supplied data is treated as untrusted.`,
            ];

            return {
                name: issueName + ' Found',
                module: moduleKey,
                severity: severity,
                description: descriptions[Math.floor(Math.random() * descriptions.length)],
                location: `Path: /api/v1/user/data?param=${Math.random().toString(36).substring(2, 8)}`,
            };
        }

        let scanSteps = [];
        let scanStartTime = 0;
        let scanInterval = null;

        function startScan() {
            if (state.isScanning || Object.values(state.scanModules).every(v => v === false)) return;

            scanSteps = [];
            const enabledModules = Object.keys(state.scanModules).filter(key => state.scanModules[key]);
            
            scanSteps.push({ type: 'LOG', message: `[INFO] Initializing scan for ${state.targetUrl}` });
            scanSteps.push({ type: 'LOG', message: '[INFO] Establishing connection to target...' });
            scanSteps.push({ type: 'LOG', message: '[SUCCESS] Connection established. Starting module execution.' });

            enabledModules.forEach(key => {
                scanSteps.push({ type: 'LOG', message: `[START] Executing module: ${moduleNames[key]}` });
                scanSteps.push({ type: 'LOG', message: `[DEBUG] Running payload injections for ${key}...` });
                const issuesToGenerate = Math.random() < (key === 'sqlInjection' || key === 'xss' ? 0.8 : 0.4) ? Math.floor(Math.random() * 3) : 0;
                scanSteps.push({ 
                    type: 'MODULE_RESULT', 
                    module: key, 
                    issues: Array(issuesToGenerate).fill(0).map(() => generateRandomIssue(key))
                });
                scanSteps.push({ type: 'LOG', message: `[DONE] Module ${moduleNames[key]} finished. Found ${issuesToGenerate} issues.` });
            });

            scanSteps.push({ type: 'LOG', message: '[INFO] All modules completed. Compiling final report...' });
            scanSteps.push({ type: 'LOG', message: '[SUCCESS] Scan complete.' });
            scanSteps.push({ type: 'FINISH' });

            setState({
                isScanning: true,
                scanLog: [],
                scanProgress: 0,
                reportData: null,
                currentPage: 'scanning',
            });

            scanStartTime = Date.now();
            window.scanStepIndex = 0;
            scanInterval = setInterval(simulateScanStep, 300);
        }

        function simulateScanStep() {
            if (window.scanStepIndex >= scanSteps.length) {
                clearInterval(scanInterval);
                return;
            }

            const step = scanSteps[window.scanStepIndex];
            const currentLog = [...state.scanLog];
            const currentIssues = state.reportData ? state.reportData.issues : [];

            if (step.type === 'LOG') {
                currentLog.push({ timestamp: Date.now(), status: step.message.match(/\[(.*?)\]/)?.[1] || 'INFO', message: step.message });
            } else if (step.type === 'MODULE_RESULT') {
                currentIssues.push(...step.issues);
            } else if (step.type === 'FINISH') {
                const durationMs = Date.now() - scanStartTime;
                const modulesScanned = Object.keys(state.scanModules).filter(key => state.scanModules[key]);

                const finalReport = {
                    targetUrl: state.targetUrl,
                    scanDate: Date.now(),
                    durationMs: durationMs,
                    modulesScanned: modulesScanned,
                    issues: currentIssues,
                };

                setState({
                    isScanning: false,
                    scanProgress: 100,
                    reportData: finalReport,
                    scanLog: currentLog,
                });

                clearInterval(scanInterval);
                setTimeout(() => navigateTo('report'), 1000);
                return;
            }

            const progress = (window.scanStepIndex / (scanSteps.length - 1)) * 100;
            
            setState({ 
                scanLog: currentLog, 
                scanProgress: Math.min(progress, 99.9),
                reportData: { issues: currentIssues }
            });

            const logContainer = document.querySelector('.custom-scrollbar');
            if (logContainer) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            window.scanStepIndex++;
        }

        function downloadReportPdf() {
            const element = document.getElementById('report-content');
            
            // html2pdf is smart enough to handle the default styles, 
            // but we need to ensure the report content exists.
            if (!element) return; 

            const options = {
                margin: 10,
                filename: `NIQAT_Al-Daef_Report_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().from(element).set(options).save();
        }

        // Main App Renderer
        function renderApp() {
            const app = document.getElementById('app');
            let content = '';

            // Decide which content to render based on authentication and current page
            if (!state.isAuthenticated) {
                content = renderAuthPage();
            } else {
                switch (state.currentPage) {
                    case 'home':
                        content = renderHomePage();
                        break;
                    case 'configure':
                        content = renderConfigurePage();
                        break;
                    case 'scanning':
                        content = renderScanningPage();
                        break;
                    case 'report':
                        content = renderReportPage();
                        break;
                    default:
                        content = renderHomePage();
                }
            }

            app.innerHTML = renderHeader() + (state.isAuthenticated ? renderNavigation() : '') + content;

            // Expose required functions globally for inline event handlers
            window.handleUrlInput = handleUrlInput;
            window.validateUrl = validateUrl;
            window.toggleModule = toggleModule;
            window.startScan = startScan;
            window.downloadReportPdf = downloadReportPdf;
            window.navigateTo = navigateTo; 
            window.handleAuthAction = handleAuthAction;
            window.handleGuestLogin = handleGuestLogin;
            window.handleSignOut = handleSignOut;
            window.setAuthMode = setAuthMode;
        }

        // Initial setup on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });

    </script>
</body>
</html>
